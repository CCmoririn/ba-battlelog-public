<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ブルアカ対抗戦DBサンプルUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .main-card {
      max-width: 720px;
      margin: 28px auto 0 auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 32px #2277bb08;
      padding: 34px 22px 22px 22px;
    }
    .section-title {
      font-size: 1.25em;
      font-weight: bold;
      margin-bottom: 12px;
      color: #2277bb;
    }
    .def-slot {
      width: 48px; height: 48px;
      border-radius: 8px;
      margin: 0 7px;
      background: #eaf0ff;
      display: flex; align-items: center; justify-content: center;
      position: relative;
      cursor: pointer;
      font-size: 0.92em;
    }
    .def-slot img {
      width: 44px; height: 44px; border-radius: 7px;
    }
    .remove-icon {
      position: absolute;
      top: 2px; right: 2px;
      background: #fff; border: none; color: #d22;
      font-size: 1.15em; border-radius: 50%; width: 18px; height: 18px;
      cursor: pointer;
      box-shadow: 0 0 4px #8882;
      padding: 0;
    }
    .slot-label {
      width: 48px;
      text-align: center;
      font-size: 0.98em;
      color: #888;
      margin: 0 7px;
    }
    .search-btn {
      min-width: 160px;
      font-size: 1.12em;
    }
    .search-results-section {
      margin-top: 48px;
      margin-bottom: 32px;
      max-width: 900px;
      background: #f7fafd;
      border-radius: 18px;
      box-shadow: 0 6px 28px #7890b010;
      padding: 24px 28px;
    }
    .search-result-title {
      font-size: 1.17em;
      color: #2277bb;
      font-weight: bold;
      margin-bottom: 16px;
    }
    .result-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 28px;
      margin-bottom: 24px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 12px #338eda13;
      padding: 22px 10px 14px 10px;
    }
    .side-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 180px;
      max-width: 210px;
    }
    .side-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-bottom: 4px;
      object-fit: contain;
      box-shadow: 0 1px 8px #338eda23;
      background: #e8f3ff;
      padding: 3px;
    }
    .char-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .char-img {
      width: 36px; height: 36px;
      border-radius: 7px;
      background: #eaf0ff;
      object-fit: cover;
      box-shadow: 0 0 8px #aac6f220;
    }
    .vs-mark {
      font-weight: bold;
      font-size: 1.3em;
      margin: 0 14px;
      color: #338eda;
    }
    .result-date {
      color: #999;
      font-size: 0.97em;
      text-align: center;
      margin-top: 6px;
    }
    @media (max-width: 768px) {
      .main-card, .search-results-section { padding: 12px 2vw; }
      .result-row { flex-direction: column; gap: 7px; padding: 10px 0; }
      .side-col { min-width: 110px; max-width: 100%; }
      .def-slot, .slot-label { margin: 0 2px; }
    }
  </style>
</head>
<body>
  <div class="main-card">
    <h2 class="section-title text-center mb-3">対抗戦 編成検索</h2>
    <div class="text-center mb-3">
      <button id="atkTab" class="btn btn-outline-primary active" type="button">攻撃側で検索</button>
      <button id="defTab" class="btn btn-outline-secondary" type="button">防衛側で検索</button>
    </div>
    <div id="defenseRow" class="d-flex justify-content-center mb-2"></div>
    <div id="slotLabelRow" class="d-flex justify-content-center mb-3"></div>
    <div class="text-center">
      <button class="btn btn-success search-btn" type="button">この編成で検索</button>
    </div>
  </div>

  <!-- 検索結果欄 -->
  <div class="search-results-section" id="searchResultsSection" style="display:none;">
    <div class="search-result-title">検索結果一覧</div>
    <div id="searchResults"></div>
  </div>

  <script>
    // サーバーから受け取ったSTRIKER/SPECIALキャラリスト
    const strikerList = {{ striker_list | tojson }};
    const specialList = {{ special_list | tojson }};

    const atkLabels = ["A1", "A2", "A3", "A4", "SP", "SP"];
    const defLabels = ["D1", "D2", "D3", "D4", "SP", "SP"];

    let atkOrDef = "防衛"; // 攻撃/防衛表示切替
    let defenseTeam = [null, null, null, null, null, null]; // 6枠
    let currSlot = null; // 現在編集中の枠

    // モーダル部分やキャラ選択処理などは省略（もともとのUIのままでOK）
    // 以下は検索・切り替え・結果描画部分

    // 検索ボタンのイベント
    document.querySelector(".search-btn").onclick = async () => {
      const charNames = defenseTeam.map(c => c ? c.name : "");
      const side = atkOrDef === "攻撃" ? "attack" : "defense";
      const res = await fetch("/api/search", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({side: side, characters: charNames})
      });
      const data = await res.json();
      showSearchResults(data.results || []);
    };

    // 検索結果表示
    function showSearchResults(results) {
      const section = document.getElementById("searchResultsSection");
      const container = document.getElementById("searchResults");
      section.style.display = results.length > 0 ? "block" : "none";
      container.innerHTML = "";

      if (results.length === 0) {
        container.innerHTML = "<div style='color:#888;font-size:1.05em;'>該当するログはありませんでした。</div>";
        return;
      }

      results.forEach(res => {
        const winnerChars = res.winner_characters.map(name => charImageTag(name));
        const loserChars  = res.loser_characters.map(name => charImageTag(name));
        const winnerIcon = res.winner_icon ? `<img class="side-icon" src="${res.winner_icon}" alt="side">` : "";
        const loserIcon  = res.loser_icon  ? `<img class="side-icon" src="${res.loser_icon}" alt="side">` : "";
        const dateTag = res.date ? `<div class="result-date">${res.date}</div>` : "";

        container.innerHTML += `
          <div class="result-row">
            <div class="side-col">
              ${winnerIcon}
              <div class="char-row">${winnerChars.join('')}</div>
              <div style="font-weight:bold;color:#2288aa;">勝ち</div>
              ${dateTag}
            </div>
            <div class="vs-mark">VS</div>
            <div class="side-col">
              ${loserIcon}
              <div class="char-row">${loserChars.join('')}</div>
              <div style="font-weight:bold;color:#aa3333;">負け</div>
              ${dateTag}
            </div>
          </div>
        `;
      });
    }

    // キャラ画像（URL）を取得
    function charImageTag(name) {
      if (!name) return `<span style="width:36px;height:36px;display:inline-block;"></span>`;
      let all = strikerList.concat(specialList);
      let found = all.find(c => c.name === name);
      if (found && found.image) {
        return `<img class="char-img" src="${found.image}" alt="${name}">`;
      } else {
        return `<span class="char-img" style="background:#eee;border:1px solid #ddd;"></span>`;
      }
    }

    // 6枠の描画
    function renderDefenseRow() {
      const row = document.getElementById("defenseRow");
      row.innerHTML = "";
      defenseTeam.forEach((ch, idx) => {
        const slot = document.createElement("div");
        slot.className = "def-slot";
        slot.onclick = () => openModal(idx); // openModalは既存実装
        if (ch) {
          slot.innerHTML = `<img src="${ch.image}" alt="${ch.name}"><button class="remove-icon" onclick="removeChar(event,${idx})">&times;</button>`;
        } else {
          slot.innerHTML = `<span style="opacity:0.6;">EMPTY</span>`;
        }
        row.appendChild(slot);
      });

      // ラベルを下行で別に表示
      const labelRow = document.getElementById("slotLabelRow");
      labelRow.innerHTML = "";
      const slotLabels = atkOrDef === "攻撃" ? atkLabels : defLabels;
      slotLabels.forEach(label => {
        const div = document.createElement("div");
        div.className = "slot-label";
        div.textContent = label;
        labelRow.appendChild(div);
      });
    }
    window.removeChar = function(e, idx) {
      e.stopPropagation();
      defenseTeam[idx] = null;
      renderDefenseRow();
    }

    // 攻撃/防衛切り替え
    document.getElementById("atkTab").onclick = () => {
      atkOrDef = "攻撃";
      document.getElementById("atkTab").classList.add("active");
      document.getElementById("defTab").classList.remove("active");
      document.querySelector('.section-title').innerText = "対抗戦 編成検索";
      renderDefenseRow();
    };
    document.getElementById("defTab").onclick = () => {
      atkOrDef = "防衛";
      document.getElementById("defTab").classList.add("active");
      document.getElementById("atkTab").classList.remove("active");
      document.querySelector('.section-title').innerText = "対抗戦 編成検索";
      renderDefenseRow();
    };

    // 初期表示
    renderDefenseRow();
  </script>
</body>
</html>
